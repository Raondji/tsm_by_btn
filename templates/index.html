<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TSM by BTN - Hybrid AI Talent Scoring</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f6fa; font-family: 'Poppins', sans-serif; }
    .card { border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
    table th, table td { vertical-align: middle !important; font-size: 13px; }
    .status-lolos { background-color: #d4edda; color: #155724; border-radius: 8px; padding: 5px 10px; font-weight: 600; }
    .status-tidak { background-color: #f8d7da; color: #721c24; border-radius: 8px; padding: 5px 10px; font-weight: 600; }
    .status-pertimbangan { background-color: #fff3cd; color: #856404; border-radius: 8px; padding: 5px 10px; font-weight: 600; }
    .summary-box { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .summary-item { text-align: center; font-weight: 600; color: #333; }
    .summary-number { font-size: 1.4rem; font-weight: bold; color: #0d6efd; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4">
      <h2 class="text-center mb-4">ðŸŽ¯ Hybrid AI Talent Scoring (TSM by BTN)</h2>

      <div class="text-center mb-4">
        <input type="file" id="csvFile" accept=".csv" class="form-control w-50 mx-auto" />
        <small class="text-muted">Upload file CSV (gunakan delimiter ; atau ,)</small>
      </div>

      <div class="text-center mb-4 d-none" id="filterSection">
        <label for="statusFilter" class="form-label fw-bold">Filter berdasarkan Status:</label>
        <select id="statusFilter" class="form-select w-50 mx-auto">
          <option value="Semua">Semua Kandidat</option>
          <option value="Lolos">Lolos</option>
          <!-- <option value="Pertimbangan">Pertimbangan</option> -->
          <option value="Tidak Lolos">Tidak Lolos</option>
        </select>
      </div>

      <div id="scoreSummary" class="summary-box d-none">
        <div class="row text-center">
          <div class="col-md-3 summary-item">
            <div class="summary-number" id="totalKandidat">0</div><div>Total Kandidat</div>
          </div>
          <div class="col-md-3 summary-item">
            <div class="summary-number text-success" id="totalLulus">0</div><div>Lulus</div>
          </div>
          <div class="col-md-3 summary-item">
            <div class="summary-number text-danger" id="totalTidak">0</div><div>Tidak Lulus</div>
          </div>
          <div class="col-md-3 summary-item">
            <div class="summary-number text-warning" id="rataRataSkor">0</div><div>Rata-rata Total Skor</div>
          </div>
        </div>
      </div>

      <div id="csvResult" class="table-responsive"></div>
    </div>
  </div>

<script>
/* ====== GLOBAL ====== */
let allData = [];       // hasil dari Flask (diproses)
let rawData = [];       // data mentah CSV (dinormalisasi keys)
let orderedHeaders = [
  "Hybrid_Ranking","Nama","Universitas","Jurusan","IPK","TOEFL","Umur",
  "Ijazah","Expected_Salary","Sertifikasi","SKCK","Pernah_Judi_Online",
  "Pernah_Kerja","Lama_Pengalaman_Kerja","Pernah_Ikut_Organisasi",
  "Durasi_Keaktifan_Organisasi","Pernah_Narkoba",
  // skor & status harus berada setelah Pernah_Narkoba:
  "Hybrid_Score","Predictive_Score","Rule_Score","Total_Score","Status"
];

/* ====== util ====== */
function toNumber(value) {
  if (value === null || value === undefined) return 0;
  if (typeof value === 'number') return value;
  let str = String(value).trim();
  if (str === "" || str.toLowerCase()==="null" || str.toLowerCase()==="undefined") return 0;
  str = str.replace(/[^0-9.\-]/g, "");
  const n = parseFloat(str);
  return isNaN(n) ? 0 : n;
}
function normalizeKey(k) {
  if (!k && k !== 0) return "";
  return String(k).trim().replace(/\s+/g, "_");
}

/* ====== parse CSV (normalize headers -> underscores) ====== */
function parseCSV(text) {
  const delimiter = text.includes(";") ? ";" : ",";
  const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
  if (rows.length < 1) return { headers: [], data: [] };
  const rawHeaders = rows[0].split(delimiter).map(h => h.trim());
  const headers = rawHeaders.map(h => normalizeKey(h));
  const data = [];
  for (let i = 1; i < rows.length; i++) {
    const cols = rows[i].split(delimiter).map(c => c.trim());
    if (cols.length !== rawHeaders.length) continue;
    const obj = {};
    for (let j = 0; j < headers.length; j++) obj[headers[j]] = cols[j];
    data.push(obj);
  }
  return { headers, data };
}

/* ====== Merge hasil Flask (processed) dengan rawData tanpa menimpa skor ======
   - processed: array of objects returned by Flask (keys expected normalized already)
   - rawData: array parsed from CSV (normalized keys)
   Matching done by Nama (normalized).
*/
function mergeWithRawData(processedArray) {
  // build lookup by Nama from rawData (normalize Nama)
  const lookup = {};
  rawData.forEach(r => {
    const n = (r["Nama"] || "").trim();
    if (!n) return;
    lookup[n] = r;
  });

  return processedArray.map(proc => {
    const name = (proc["Nama"] || "").trim();
    const original = lookup[name];
    if (!original) {
      // still ensure normalized keys exist in returned object
      const out = { ...proc };
      // make sure ordered keys exist (so table shows empty not undefined)
      orderedHeaders.forEach(k => { if (!(k in out)) out[k] = ""; });
      return out;
    }
    // merge: original first, then proc (so proc overwrites fields if same name),
    // but we then forcibly keep certain proc-ed values (scores & status)
    const merged = { ...original, ...proc };
    // ensure the model values remain as in proc
    merged["Predictive_Score"] = proc["Predictive_Score"];
    merged["Rule_Score"] = proc["Rule_Score"];
    merged["Total_Score"] = proc["Total_Score"];
    merged["Status"] = proc["Status"];
    merged["Hybrid_Score"] = proc["Hybrid_Score"] ?? merged["Hybrid_Score"];
    // make sure all expected keys exist
    orderedHeaders.forEach(k => { if (!(k in merged)) merged[k] = ""; });
    return merged;
  });
}

/* ====== Upload handler (single listener) ====== */
document.getElementById("csvFile").addEventListener("change", async function(e) {
  const file = e.target.files[0];
  if (!file) return alert("Pilih file CSV dulu!");
  // read raw CSV and normalize headers
  const text = await file.text();
  const parsed = parseCSV(text);
  rawData = parsed.data;

  // send file to backend (Flask) which returns processed array
  const form = new FormData();
  form.append("file", file);
  try {
    const res = await fetch("/upload", { method: "POST", body: form });
    const data = await res.json();
    if (!res.ok) {
      alert("Error dari server: " + (data.error || "Gagal memproses file di server"));
      return;
    }
    // normalize keys in returned data: convert header keys to normalized form
    // (some backends might return keys with spaces/other; ensure keys exist with normalized names)
    const normalizedProcessed = data.map(item => {
      const out = {};
      Object.keys(item).forEach(k => {
        const nk = normalizeKey(k);
        out[nk] = item[k];
      });
      // also ensure we have known score fields accessible by normalized names
      // if backend used other names, user must ensure backend keys match expected names.
      return out;
    });

    // Merge with rawData (matching by Nama) and set into allData
    allData = mergeWithRawData(normalizedProcessed);

    // sort by Total_Score descending (if numeric); keep non-numeric at bottom
    allData.sort((a,b) => toNumber(b["Total_Score"]) - toNumber(a["Total_Score"]));

    // render
    renderTable(allData);
    document.getElementById("filterSection").classList.remove("d-none");
  } catch (err) {
    console.error(err);
    alert("Terjadi error saat upload: " + err.message);
  }
});

/* ====== Filter UI ====== */
document.getElementById("statusFilter").addEventListener("change", function(e) {
  const f = e.target.value;
  let filtered = allData;
  if (f !== "Semua") filtered = allData.filter(r => (r["Status"] || "") === f);
  renderTable(filtered);
});

/* ====== Render table with strict orderedHeaders (forced order) ====== */
function renderTable(data) {
  if (!data || data.length === 0) {
    document.getElementById("csvResult").innerHTML = "<p class='text-center text-danger'>Tidak ada data untuk ditampilkan.</p>";
    document.getElementById("scoreSummary").classList.add("d-none");
    return;
  }

  // compute stats (Total_Score may be string; use toNumber)
  const total = data.length;
  const lulus = data.filter(d => (d["Status"] || "") === "Lolos").length;
  const tidak = data.filter(d => (d["Status"] || "") === "Tidak Lolos").length;
  const rata = total > 0 ? (data.reduce((s,d)=> s + toNumber(d["Total_Score"]),0)/total).toFixed(2) : "0.00";

  document.getElementById("totalKandidat").textContent = total;
  document.getElementById("totalLulus").textContent = lulus;
  document.getElementById("totalTidak").textContent = tidak;
  document.getElementById("rataRataSkor").textContent = rata;
  document.getElementById("scoreSummary").classList.remove("d-none");

  // build header row using orderedHeaders exactly
  const headerRow = orderedHeaders.map(h => `<th>${h.replace(/_/g," ")}</th>`).join("");

  // build rows
  const tableRows = data.map((row, idx) => {
    // ensure Hybrid_Ranking is present and corresponds to sorted order
    row["Hybrid_Ranking"] = idx + 1;
    // ensure Hybrid_Score fallback to Total_Score if missing
    if (!row["Hybrid_Score"] && row["Total_Score"]) row["Hybrid_Score"] = row["Total_Score"];

    let cells = "";
    orderedHeaders.forEach(h => {
      let val = row[h];
      if (val === null || val === undefined) val = "";
      // format score columns as numbers with 2 decimals
      if (["Rule_Score","Predictive_Score","Hybrid_Score","Total_Score"].includes(h)) {
        cells += `<td class="text-end"><strong>${toNumber(val).toFixed(2)}</strong></td>`;
      } else if (h === "Status") {
        const cls = (val === "Lolos") ? "status-lolos" : (val === "Tidak Lolos") ? "status-tidak" : "status-pertimbangan";
        cells += `<td><span class="${cls}">${val}</span></td>`;
      } else if (h === "Hybrid_Ranking") {
        cells += `<td class="text-center fw-bold">${val}</td>`;
      } else {
        // escape HTML in text values to be safe
        const safe = String(val).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        cells += `<td>${safe}</td>`;
      }
    });
    return `<tr>${cells}</tr>`;
  }).join("");

  document.getElementById("csvResult").innerHTML = `
    <h5 class="mb-3 text-center text-secondary">Hasil Seleksi Kandidat (Urut Berdasarkan Total_Score Tertinggi)</h5>
    <table class="table table-striped table-bordered table-sm align-middle">
      <thead class="table-primary"><tr>${headerRow}</tr></thead>
      <tbody>${tableRows}</tbody>
    </table>
  `;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
